<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>スーパーマリオ風ゲーム</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #5c94fc;
        font-family: Arial, sans-serif;
      }
      #game-container {
        position: relative;
      }
      .mobile-controls {
        position: absolute;
        bottom: 20px;
        display: none;
        gap: 10px;
        width: 100%;
        justify-content: space-between;
        padding: 0 20px;
        box-sizing: border-box;
      }
      .control-btn {
        background: rgba(255, 255, 255, 0.7);
        border: 3px solid #333;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      .control-btn:active {
        background: rgba(255, 255, 255, 0.9);
      }
      @media (max-width: 768px) {
        .mobile-controls {
          display: flex;
        }
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <div class="mobile-controls">
        <div style="display: flex; gap: 10px">
          <button class="control-btn" id="leftBtn">←</button>
          <button class="control-btn" id="rightBtn">→</button>
        </div>
        <button class="control-btn" id="jumpBtn">↑</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <script>
      // アセット生成クラス
      class AssetGenerator {
        static createPixelArt(width, height, drawFunc) {
          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.imageSmoothingEnabled = false;
          drawFunc(ctx);
          return canvas;
        }

        static createPixelArtDataURL(width, height, drawFunc) {
          const canvas = this.createPixelArt(width, height, drawFunc);
          return canvas.toDataURL();
        }
      }

      // タイトルシーン
      class TitleScene extends Phaser.Scene {
        constructor() {
          super({ key: "TitleScene" });
        }

        preload() {
          // プリロードは不要
        }

        create() {
          // 背景の描画
          this.createTitleBackground();

          // タイトルテキスト
          const titleStyle = {
            fontSize: "48px",
            fontFamily: "Arial Black",
            color: "#FFFFFF",
            stroke: "#000000",
            strokeThickness: 8,
          };

          this.add.text(400, 200, "SUPER MARIO", titleStyle).setOrigin(0.5);
          this.add.text(400, 260, "ADVENTURE", titleStyle).setOrigin(0.5);

          // スタートテキスト
          const startText = this.add
            .text(400, 350, "PRESS SPACE or TAP TO START", {
              fontSize: "24px",
              fontFamily: "Arial",
              color: "#FFD700",
              stroke: "#000000",
              strokeThickness: 4,
            })
            .setOrigin(0.5);

          // 点滅アニメーション
          this.tweens.add({
            targets: startText,
            alpha: 0,
            duration: 500,
            ease: "Power2",
            yoyo: true,
            repeat: -1,
          });

          // コントロール説明
          const isMobile =
            /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
              navigator.userAgent
            );
          const controlText = isMobile
            ? "Use on-screen buttons to play"
            : "Arrow Keys: Move | Space: Jump";

          this.add
            .text(400, 450, controlText, {
              fontSize: "18px",
              fontFamily: "Arial",
              color: "#FFFFFF",
              stroke: "#000000",
              strokeThickness: 3,
            })
            .setOrigin(0.5);

          // 入力設定
          this.input.keyboard.once("keydown-SPACE", () => {
            this.scene.start("GameScene", { stage: 1 });
          });

          this.input.once("pointerdown", () => {
            this.scene.start("GameScene", { stage: 1 });
          });
        }

        createTitleBackground() {
          // 空のグラデーション背景
          const graphics = this.add.graphics();
          const rect = new Phaser.Geom.Rectangle(0, 0, 800, 600);
          graphics.fillGradientStyle(0x5c94fc, 0x5c94fc, 0x5c7cfa, 0x5c7cfa, 1);
          graphics.fillRectShape(rect);

          // より本物らしい雲を描画
          const drawCloud = (x, y, scale = 1) => {
            const cloud = this.add.graphics();

            // メインの雲
            cloud.fillStyle(0xffffff, 0.9);
            cloud.fillRoundedRect(x, y, 100 * scale, 40 * scale, 20 * scale);
            cloud.fillCircle(x + 20 * scale, y + 10 * scale, 25 * scale);
            cloud.fillCircle(x + 50 * scale, y + 5 * scale, 30 * scale);
            cloud.fillCircle(x + 80 * scale, y + 10 * scale, 25 * scale);

            // 影の部分
            cloud.fillStyle(0xf0f0f0, 0.5);
            cloud.fillRoundedRect(
              x + 5 * scale,
              y + 30 * scale,
              90 * scale,
              15 * scale,
              10 * scale
            );
          };

          drawCloud(100, 80, 1.2);
          drawCloud(500, 120, 0.8);
          drawCloud(300, 200, 1.0);

          // 地面
          const ground = this.add.graphics();
          ground.fillStyle(0xc84c0c, 1);
          ground.fillRect(0, 500, 800, 100);

          // 地面の模様
          ground.lineStyle(2, 0x000000, 1);
          for (let x = 0; x < 800; x += 40) {
            ground.lineBetween(x, 500, x, 600);
          }

          // タイトル背景
          const titleBg = this.add.graphics();
          titleBg.fillStyle(0x000000, 0.5);
          titleBg.fillRect(150, 150, 500, 200);

          // タイトル枠
          titleBg.lineStyle(8, 0xffd700, 1);
          titleBg.strokeRect(150, 150, 500, 200);
        }
      }

      // ゲームシーン
      class GameScene extends Phaser.Scene {
        constructor() {
          super({ key: "GameScene" });
        }

        init(data) {
          this.currentStage = data.stage || 1;
          this.score = data.score || 0;
          this.lives = data.lives || 3;
        }

        preload() {
          this.load.image("mario-idle", "mario-idle.png");
          this.load.image("mario-jump", "mario-jump.png");
          this.load.image("mario-walk1", "mario-walk1.png");
          this.load.image("mario-walk2", "mario-walk2.png");
          this.load.image("mario-walk3", "mario-walk3.png");

          this.createAssetTextures();
        }

        createAssetTextures() {
          if (this.textures.exists("coin")) {
            return;
          }

          this.textures.addCanvas(
            "coin",
            AssetGenerator.createPixelArt(16, 16, (ctx) => {
              // コインの外枠
              ctx.fillStyle = "#FFD700";
              ctx.fillRect(4, 0, 8, 16);
              ctx.fillRect(2, 2, 12, 12);
              ctx.fillRect(0, 4, 16, 8);

              // ハイライト
              ctx.fillStyle = "#FFFF00";
              ctx.fillRect(5, 2, 4, 4);

              // 影
              ctx.fillStyle = "#DAA520";
              ctx.fillRect(7, 10, 4, 4);
            })
          );

          this.textures.addCanvas(
            "mushroom",
            AssetGenerator.createPixelArt(16, 16, (ctx) => {
              // キノコの傘
              ctx.fillStyle = "#FF0000";
              ctx.fillRect(2, 2, 12, 8);
              ctx.fillRect(0, 4, 16, 4);

              // 白い斑点
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(3, 3, 3, 3);
              ctx.fillRect(10, 3, 3, 3);
              ctx.fillRect(6, 5, 4, 2);

              // 茎
              ctx.fillStyle = "#FFE4B5";
              ctx.fillRect(5, 8, 6, 8);

              // 顔
              ctx.fillStyle = "#000000";
              ctx.fillRect(6, 10, 1, 2);
              ctx.fillRect(9, 10, 1, 2);
            })
          );

          this.textures.addCanvas(
            "goomba",
            AssetGenerator.createPixelArt(16, 16, (ctx) => {
              // 体
              ctx.fillStyle = "#8B4513";
              ctx.fillRect(2, 4, 12, 8);
              ctx.fillRect(0, 6, 16, 4);

              // 顔
              ctx.fillStyle = "#D2691E";
              ctx.fillRect(4, 2, 8, 10);

              // 目
              ctx.fillStyle = "#000000";
              ctx.fillRect(5, 5, 2, 3);
              ctx.fillRect(9, 5, 2, 3);

              // 眉毛
              ctx.fillRect(4, 4, 3, 1);
              ctx.fillRect(9, 4, 3, 1);

              // 牙
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(6, 9, 1, 2);
              ctx.fillRect(9, 9, 1, 2);

              // 足
              ctx.fillStyle = "#000000";
              ctx.fillRect(3, 12, 3, 4);
              ctx.fillRect(10, 12, 3, 4);
            })
          );

          this.textures.addCanvas(
            "koopa",
            AssetGenerator.createPixelArt(16, 20, (ctx) => {
              // 甲羅
              ctx.fillStyle = "#00FF00";
              ctx.fillRect(2, 8, 12, 10);
              ctx.fillRect(0, 10, 16, 6);

              // 甲羅の模様
              ctx.fillStyle = "#008000";
              ctx.fillRect(4, 10, 3, 3);
              ctx.fillRect(9, 10, 3, 3);
              ctx.fillRect(6, 13, 4, 3);

              // 頭
              ctx.fillStyle = "#FFE4B5";
              ctx.fillRect(5, 2, 6, 8);

              // 目
              ctx.fillStyle = "#000000";
              ctx.fillRect(6, 4, 2, 2);
              ctx.fillRect(9, 4, 2, 2);

              // くちばし
              ctx.fillStyle = "#FFA500";
              ctx.fillRect(11, 5, 3, 3);

              // 足
              ctx.fillStyle = "#FFA500";
              ctx.fillRect(3, 16, 3, 4);
              ctx.fillRect(10, 16, 3, 4);
            })
          );

          this.textures.addCanvas(
            "fireflower",
            AssetGenerator.createPixelArt(16, 16, (ctx) => {
              // 茎
              ctx.fillStyle = "#00FF00";
              ctx.fillRect(7, 8, 2, 8);

              // 葉
              ctx.fillStyle = "#00FF00";
              ctx.fillRect(4, 10, 3, 2);
              ctx.fillRect(9, 10, 3, 2);

              // 花びら
              ctx.fillStyle = "#FF0000";
              ctx.fillRect(5, 0, 6, 6);
              ctx.fillRect(2, 3, 12, 3);

              // 花の中心
              ctx.fillStyle = "#FFFF00";
              ctx.fillRect(6, 2, 4, 4);

              // 目
              ctx.fillStyle = "#000000";
              ctx.fillRect(7, 3, 1, 1);
              ctx.fillRect(9, 3, 1, 1);
            })
          );

          this.textures.addCanvas(
            "brick",
            AssetGenerator.createPixelArt(16, 16, (ctx) => {
              // ベース色
              ctx.fillStyle = "#8B4513";
              ctx.fillRect(0, 0, 16, 16);

              // レンガの線
              ctx.fillStyle = "#654321";
              // 横線
              ctx.fillRect(0, 4, 16, 1);
              ctx.fillRect(0, 10, 16, 1);
              ctx.fillRect(0, 15, 16, 1);
              // 縦線
              ctx.fillRect(7, 0, 1, 4);
              ctx.fillRect(3, 5, 1, 5);
              ctx.fillRect(11, 5, 1, 5);
              ctx.fillRect(7, 11, 1, 4);
            })
          );

          this.textures.addCanvas(
            "question",
            AssetGenerator.createPixelArt(16, 16, (ctx) => {
              // ベース色
              ctx.fillStyle = "#FFA500";
              ctx.fillRect(0, 0, 16, 16);

              // 影
              ctx.fillStyle = "#FF8C00";
              ctx.fillRect(0, 14, 16, 2);
              ctx.fillRect(14, 0, 2, 16);

              // ハイライト
              ctx.fillStyle = "#FFFF00";
              ctx.fillRect(0, 0, 2, 16);
              ctx.fillRect(0, 0, 16, 2);

              // はてなマーク
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(6, 3, 4, 2);
              ctx.fillRect(9, 5, 2, 3);
              ctx.fillRect(6, 7, 4, 2);
              ctx.fillRect(6, 11, 4, 2);
            })
          );

          this.textures.addCanvas(
            "pipe",
            AssetGenerator.createPixelArt(32, 48, (ctx) => {
              // パイプの口
              ctx.fillStyle = "#00AA00";
              ctx.fillRect(0, 0, 32, 16);

              // 影
              ctx.fillStyle = "#006600";
              ctx.fillRect(0, 14, 32, 2);
              ctx.fillRect(30, 0, 2, 16);

              // ハイライト
              ctx.fillStyle = "#00FF00";
              ctx.fillRect(0, 0, 2, 16);
              ctx.fillRect(0, 0, 32, 2);

              // パイプ本体
              ctx.fillStyle = "#00AA00";
              ctx.fillRect(4, 16, 24, 32);

              // 本体の影
              ctx.fillStyle = "#006600";
              ctx.fillRect(26, 16, 2, 32);

              // 本体のハイライト
              ctx.fillStyle = "#00FF00";
              ctx.fillRect(4, 16, 2, 32);
            })
          );

          this.textures.addCanvas(
            "flag",
            AssetGenerator.createPixelArt(48, 176, (ctx) => {
              // ポール
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(2, 0, 4, 176);

              // ポールの影
              ctx.fillStyle = "#CCCCCC";
              ctx.fillRect(4, 0, 2, 176);

              // 旗
              ctx.fillStyle = "#00FF00";
              ctx.fillRect(6, 16, 32, 24);

              // 旗の模様
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(10, 20, 24, 16);

              // ポールの先端
              ctx.fillStyle = "#FFD700";
              ctx.fillRect(0, 0, 8, 8);
              ctx.fillRect(2, 8, 4, 4);
            })
          );

          this.textures.addCanvas(
            "cloud",
            AssetGenerator.createPixelArt(64, 32, (ctx) => {
              // より本物らしい雲の描画
              ctx.fillStyle = "#FFFFFF";

              // メインの雲の塊
              // 中央の大きな部分
              ctx.fillRect(16, 12, 32, 12);

              // 上部の膨らみ
              ctx.fillRect(20, 8, 24, 8);
              ctx.fillRect(24, 4, 16, 8);
              ctx.fillRect(28, 2, 8, 4);

              // 左側の膨らみ
              ctx.fillRect(8, 14, 12, 8);
              ctx.fillRect(12, 10, 8, 8);
              ctx.fillRect(14, 8, 6, 4);

              // 右側の膨らみ
              ctx.fillRect(44, 14, 12, 8);
              ctx.fillRect(44, 10, 8, 8);
              ctx.fillRect(44, 8, 6, 4);

              // 下部の影（薄いグレー）
              ctx.fillStyle = "#F0F0F0";
              ctx.fillRect(14, 22, 36, 4);
              ctx.fillRect(18, 24, 28, 2);

              // ハイライト（より明るい白）
              ctx.fillStyle = "#FAFAFA";
              ctx.fillRect(26, 6, 12, 4);
              ctx.fillRect(22, 10, 8, 4);
              ctx.fillRect(34, 10, 8, 4);
            })
          );

          this.textures.addCanvas(
            "bush",
            AssetGenerator.createPixelArt(48, 16, (ctx) => {
              ctx.fillStyle = "#00AA00";
              // 茂みの形
              ctx.fillRect(8, 8, 32, 8);
              ctx.fillRect(4, 4, 8, 8);
              ctx.fillRect(36, 4, 8, 8);
              ctx.fillRect(12, 2, 24, 6);
              ctx.fillRect(16, 0, 16, 2);
            })
          );

          this.textures.addCanvas(
            "star",
            AssetGenerator.createPixelArt(16, 16, (ctx) => {
              // スター
              ctx.fillStyle = "#FFD700";
              // 中心
              ctx.fillRect(6, 6, 4, 4);
              // 上
              ctx.fillRect(7, 0, 2, 6);
              // 下
              ctx.fillRect(7, 10, 2, 6);
              // 左
              ctx.fillRect(0, 7, 6, 2);
              // 右
              ctx.fillRect(10, 7, 6, 2);
              // 斜め
              ctx.fillRect(3, 3, 3, 3);
              ctx.fillRect(10, 3, 3, 3);
              ctx.fillRect(3, 10, 3, 3);
              ctx.fillRect(10, 10, 3, 3);

              // 目
              ctx.fillStyle = "#000000";
              ctx.fillRect(5, 6, 1, 2);
              ctx.fillRect(10, 6, 1, 2);
            })
          );

          this.textures.addCanvas(
            "piranha",
            AssetGenerator.createPixelArt(24, 32, (ctx) => {
              // 茎
              ctx.fillStyle = "#00AA00";
              ctx.fillRect(10, 16, 4, 16);

              // 葉
              ctx.fillStyle = "#00FF00";
              ctx.fillRect(6, 20, 4, 4);
              ctx.fillRect(14, 20, 4, 4);

              // 頭
              ctx.fillStyle = "#FF0000";
              ctx.fillRect(4, 0, 16, 16);

              // 斑点
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(6, 2, 3, 3);
              ctx.fillRect(15, 2, 3, 3);
              ctx.fillRect(10, 6, 4, 3);

              // 口
              ctx.fillStyle = "#000000";
              ctx.fillRect(4, 10, 16, 2);

              // 歯
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(6, 8, 2, 4);
              ctx.fillRect(10, 8, 2, 4);
              ctx.fillRect(14, 8, 2, 4);
              ctx.fillRect(8, 10, 2, 4);
              ctx.fillRect(12, 10, 2, 4);
              ctx.fillRect(16, 10, 2, 4);
            })
          );

          this.textures.addCanvas(
            "lakitu",
            AssetGenerator.createPixelArt(24, 24, (ctx) => {
              // 雲
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(2, 14, 20, 6);
              ctx.fillRect(0, 16, 24, 4);
              ctx.fillRect(4, 12, 16, 2);
              ctx.fillRect(6, 20, 12, 2);

              // 体
              ctx.fillStyle = "#00AA00";
              ctx.fillRect(8, 6, 8, 10);

              // 顔
              ctx.fillStyle = "#FFE4B5";
              ctx.fillRect(9, 2, 6, 6);

              // メガネ
              ctx.fillStyle = "#000000";
              ctx.fillRect(8, 3, 8, 3);
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(9, 4, 2, 1);
              ctx.fillRect(13, 4, 2, 1);
            })
          );

          this.textures.addCanvas(
            "spiny",
            AssetGenerator.createPixelArt(16, 16, (ctx) => {
              // 体
              ctx.fillStyle = "#FF0000";
              ctx.fillRect(4, 8, 8, 6);

              // トゲ
              ctx.fillStyle = "#FFFFFF";
              // 上
              ctx.fillRect(6, 4, 1, 4);
              ctx.fillRect(9, 4, 1, 4);
              // 横
              ctx.fillRect(2, 10, 2, 1);
              ctx.fillRect(12, 10, 2, 1);
              // 斜め
              ctx.fillRect(4, 6, 2, 2);
              ctx.fillRect(10, 6, 2, 2);

              // 目
              ctx.fillStyle = "#000000";
              ctx.fillRect(5, 10, 2, 2);
              ctx.fillRect(9, 10, 2, 2);

              // 足
              ctx.fillRect(4, 14, 2, 2);
              ctx.fillRect(10, 14, 2, 2);
            })
          );

          this.textures.addCanvas(
            "hammerbro",
            AssetGenerator.createPixelArt(20, 24, (ctx) => {
              // 甲羅
              ctx.fillStyle = "#00AA00";
              ctx.fillRect(4, 12, 12, 8);

              // 体
              ctx.fillStyle = "#FFE4B5";
              ctx.fillRect(6, 6, 8, 8);

              // ヘルメット
              ctx.fillStyle = "#000000";
              ctx.fillRect(4, 2, 12, 6);
              ctx.fillRect(2, 4, 16, 2);

              // 目
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(6, 8, 2, 2);
              ctx.fillRect(12, 8, 2, 2);

              // ハンマー
              ctx.fillStyle = "#8B4513";
              ctx.fillRect(16, 6, 4, 2);
              ctx.fillRect(17, 4, 2, 6);

              // 足
              ctx.fillStyle = "#FFA500";
              ctx.fillRect(5, 20, 3, 4);
              ctx.fillRect(12, 20, 3, 4);
            })
          );

          this.textures.addCanvas(
            "castle",
            AssetGenerator.createPixelArt(160, 120, (ctx) => {
              // 城本体
              ctx.fillStyle = "#8B4513";
              ctx.fillRect(20, 40, 120, 80);

              // 塔
              ctx.fillRect(10, 20, 30, 100);
              ctx.fillRect(120, 20, 30, 100);

              // 屋根
              ctx.fillStyle = "#FF0000";
              // 中央
              for (let i = 0; i < 20; i++) {
                ctx.fillRect(60 - i, 40 - i, 40 + i * 2, 2);
              }
              // 左塔
              for (let i = 0; i < 15; i++) {
                ctx.fillRect(15 - i, 20 - i, 20 + i * 2, 2);
              }
              // 右塔
              for (let i = 0; i < 15; i++) {
                ctx.fillRect(125 - i, 20 - i, 20 + i * 2, 2);
              }

              // 門
              ctx.fillStyle = "#000000";
              ctx.fillRect(60, 80, 40, 40);

              // 窓
              ctx.fillStyle = "#FFD700";
              ctx.fillRect(40, 50, 15, 20);
              ctx.fillRect(105, 50, 15, 20);
              ctx.fillRect(20, 30, 10, 15);
              ctx.fillRect(130, 30, 10, 15);

              // 旗
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(78, 5, 2, 20);
              ctx.fillStyle = "#FF0000";
              ctx.fillRect(80, 8, 15, 10);
            })
          );
        }

        create() {
          this.physics.world.gravity.y = 900;

          const bgColors = [
            "#5C94FC",
            "#000000",
            "#FFB6C1",
            "#8B4513",
            "#1C1C1C",
          ];
          this.cameras.main.setBackgroundColor(bgColors[this.currentStage - 1]);

          this.player = this.physics.add.sprite(100, 480, "mario-idle");
          this.player.setBounce(0);
          this.player.setCollideWorldBounds(false);
          this.player.setScale(3);
          this.player.body.setSize(14, 16);
          this.player.body.setOffset(1, 0);

          this.player.isSuper = false;

          this.anims.create({
            key: "walk",
            frames: [
              { key: "mario-walk1" },
              { key: "mario-walk2" },
              { key: "mario-walk3" },
              { key: "mario-walk2" },
            ],
            frameRate: 10,
            repeat: -1,
          });

          this.anims.create({
            key: "idle",
            frames: [{ key: "mario-idle" }],
            frameRate: 1,
          });

          this.anims.create({
            key: "jump",
            frames: [{ key: "mario-jump" }],
            frameRate: 1,
          });

          this.platforms = this.physics.add.staticGroup();

          // アイテムグループ
          this.coins = this.physics.add.group();
          this.powerups = this.physics.add.group();
          this.enemies = this.physics.add.group();

          // ステージ生成
          this.generateStage();

          // コリジョン設定
          this.physics.add.collider(this.player, this.platforms);
          this.physics.add.collider(this.enemies, this.platforms);
          this.physics.add.collider(this.coins, this.platforms);
          this.physics.add.collider(this.powerups, this.platforms);

          // オーバーラップ設定
          this.physics.add.overlap(
            this.player,
            this.coins,
            this.collectCoin,
            null,
            this
          );
          this.physics.add.overlap(
            this.player,
            this.powerups,
            this.collectPowerup,
            null,
            this
          );
          this.physics.add.overlap(
            this.player,
            this.enemies,
            this.hitEnemy,
            null,
            this
          );
          this.physics.add.overlap(
            this.player,
            this.flag,
            this.reachFlag,
            null,
            this
          );

          // コントロール設定
          this.cursors = this.input.keyboard.createCursorKeys();
          this.spaceKey = this.input.keyboard.addKey(
            Phaser.Input.Keyboard.KeyCodes.SPACE
          );

          // モバイルコントロール
          this.setupMobileControls();

          // UI作成
          this.createUI();

          // カメラ設定
          this.cameras.main.setBounds(0, 0, 3200, 600);
          this.cameras.main.startFollow(this.player);

          // ワールド境界設定（下方向を広げて穴に落ちられるようにする）
          this.physics.world.setBounds(0, 0, 3200, 1200);
        }

        generateStage() {
          const stageWidth = 3200;

          for (let x = 0; x < stageWidth; x += 32) {
            if (Math.random() > 0.1 || x < 200 || x > stageWidth - 200) {
              this.platforms
                .create(x, 568, "brick")
                .setScale(2, 2)
                .refreshBody();
            }
          }

          switch (this.currentStage) {
            case 1:
              this.generateStage1();
              break;
            case 2:
              this.generateStage2();
              break;
            case 3:
              this.generateStage3();
              break;
            case 4:
              this.generateStage4();
              break;
            case 5:
              this.generateStage5();
              break;
          }

          this.flag = this.physics.add.sprite(3000, 400, "flag");
          this.flag.body.setAllowGravity(false);
        }

        generateStage1() {
          // 基本的なステージ
          // 雲と茂み（改善された雲の配置）
          for (let x = 200; x < 3000; x += 300) {
            // 雲を異なる高さに配置してより自然に
            const cloudY = 80 + Math.random() * 60;
            const cloud = this.add.image(
              x + Math.random() * 100,
              cloudY,
              "cloud"
            );
            cloud.setScale(1.5 + Math.random() * 0.5);
            cloud.setAlpha(0.8 + Math.random() * 0.2);

            if (Math.random() > 0.5) {
              this.add.image(x + 200, 520, "bush").setScale(1.5);
            }
          }

          // プラットフォーム
          this.platforms.create(400, 400, "brick").setScale(6, 1).refreshBody();
          this.platforms.create(700, 300, "brick").setScale(4, 1).refreshBody();
          this.platforms
            .create(1000, 400, "brick")
            .setScale(6, 1)
            .refreshBody();
          this.platforms
            .create(1400, 350, "brick")
            .setScale(5, 1)
            .refreshBody();
          this.platforms
            .create(1700, 450, "brick")
            .setScale(4, 1)
            .refreshBody();
          this.platforms
            .create(2000, 300, "brick")
            .setScale(6, 1)
            .refreshBody();
          this.platforms
            .create(2400, 400, "brick")
            .setScale(5, 1)
            .refreshBody();

          // ？ブロック
          this.createQuestionBlock(500, 300, "coin");
          this.createQuestionBlock(800, 200, "mushroom");
          this.createQuestionBlock(1100, 300, "coin");
          this.createQuestionBlock(1500, 250, "mushroom");

          // 土管（地面に隙間なく配置）
          this.platforms.create(1200, 504, "pipe").setScale(2).refreshBody();
          this.platforms.create(1800, 504, "pipe").setScale(2).refreshBody();
          this.platforms.create(2600, 504, "pipe").setScale(2).refreshBody();

          // 大量の敵配置
          this.createEnemy(300, 500, "goomba");
          this.createEnemy(450, 500, "goomba");
          this.createEnemy(600, 300, "goomba");
          this.createEnemy(650, 500, "koopa");
          this.createEnemy(750, 500, "goomba");
          this.createEnemy(850, 500, "goomba");
          this.createEnemy(900, 300, "goomba");
          this.createEnemy(950, 500, "koopa");
          this.createEnemy(1050, 300, "goomba");
          this.createEnemy(1100, 500, "goomba");
          this.createEnemy(1300, 500, "koopa");
          this.createEnemy(1400, 300, "goomba");
          this.createEnemy(1450, 250, "goomba");
          this.createEnemy(1500, 500, "goomba");
          this.createEnemy(1600, 500, "koopa");
          this.createEnemy(1700, 400, "goomba");
          this.createEnemy(1900, 500, "goomba");
          this.createEnemy(2000, 250, "koopa");
          this.createEnemy(2100, 500, "goomba");
          this.createEnemy(2200, 500, "koopa");
          this.createEnemy(2300, 500, "goomba");
          this.createEnemy(2400, 350, "goomba");
          this.createEnemy(2500, 500, "koopa");
          this.createEnemy(2700, 500, "goomba");

          // 大量のコイン配置（地面の上）
          for (let x = 200; x < 2800; x += 50) {
            if (Math.random() > 0.3) {
              this.coins.create(x, 520, "coin").setScale(2);
            }
          }

          // プラットフォーム上のコイン
          for (let i = 0; i < 6; i++) {
            this.coins.create(380 + i * 40, 350, "coin").setScale(2);
          }
          for (let i = 0; i < 4; i++) {
            this.coins.create(680 + i * 40, 250, "coin").setScale(2);
          }
          for (let i = 0; i < 6; i++) {
            this.coins.create(980 + i * 40, 350, "coin").setScale(2);
          }
          for (let i = 0; i < 5; i++) {
            this.coins.create(1380 + i * 40, 300, "coin").setScale(2);
          }
          for (let i = 0; i < 4; i++) {
            this.coins.create(1680 + i * 40, 400, "coin").setScale(2);
          }
          for (let i = 0; i < 6; i++) {
            this.coins.create(1980 + i * 40, 250, "coin").setScale(2);
          }

          // ジャンプで取れる高さのコイン
          for (let x = 300; x < 2700; x += 150) {
            this.coins.create(x, 450, "coin").setScale(2);
            this.coins.create(x + 50, 400, "coin").setScale(2);
            this.coins.create(x + 100, 450, "coin").setScale(2);
          }

          // キノコ（地面の上に大量配置）
          this.powerups.create(500, 520, "mushroom").setScale(2);
          this.powerups.create(800, 520, "mushroom").setScale(2);
          this.powerups.create(1100, 520, "mushroom").setScale(2);
          this.powerups.create(1500, 520, "mushroom").setScale(2);
          this.powerups.create(1900, 520, "mushroom").setScale(2);
          this.powerups.create(2300, 520, "mushroom").setScale(2);
          this.powerups.create(2700, 520, "mushroom").setScale(2);

          // ファイアフラワー
          this.powerups.create(1000, 350, "fireflower").setScale(2);
          this.powerups.create(2000, 250, "fireflower").setScale(2);
        }

        generateStage2() {
          // 夜のステージ
          // 星
          for (let i = 0; i < 20; i++) {
            const star = this.add.rectangle(
              Phaser.Math.Between(0, 3200),
              Phaser.Math.Between(0, 200),
              2,
              2,
              0xffffff
            );
            this.tweens.add({
              targets: star,
              alpha: 0,
              duration: Phaser.Math.Between(1000, 2000),
              yoyo: true,
              repeat: -1,
            });
          }

          // 動くプラットフォーム
          const movingPlatform = this.physics.add.image(600, 400, "brick");
          movingPlatform.setScale(4, 1);
          movingPlatform.body.setAllowGravity(false);
          movingPlatform.body.setImmovable(true);
          this.physics.add.collider(this.player, movingPlatform);
          this.physics.add.collider(this.enemies, movingPlatform);
          this.physics.add.collider(this.coins, movingPlatform);
          this.physics.add.collider(this.powerups, movingPlatform);

          this.tweens.add({
            targets: movingPlatform,
            x: 800,
            duration: 2000,
            yoyo: true,
            repeat: -1,
            ease: "Sine.easeInOut",
          });

          // 追加の動くプラットフォーム
          const movingPlatform2 = this.physics.add.image(1200, 300, "brick");
          movingPlatform2.setScale(3, 1);
          movingPlatform2.body.setAllowGravity(false);
          movingPlatform2.body.setImmovable(true);
          this.physics.add.collider(this.player, movingPlatform2);
          this.physics.add.collider(this.enemies, movingPlatform2);
          this.physics.add.collider(this.coins, movingPlatform2);
          this.physics.add.collider(this.powerups, movingPlatform2);

          this.tweens.add({
            targets: movingPlatform2,
            y: 450,
            duration: 1500,
            yoyo: true,
            repeat: -1,
            ease: "Sine.easeInOut",
          });

          // 追加のプラットフォーム
          this.platforms
            .create(1000, 350, "brick")
            .setScale(6, 1)
            .refreshBody();
          this.platforms
            .create(1400, 250, "brick")
            .setScale(4, 1)
            .refreshBody();
          this.platforms
            .create(1700, 400, "brick")
            .setScale(5, 1)
            .refreshBody();
          this.platforms
            .create(2000, 300, "brick")
            .setScale(4, 1)
            .refreshBody();
          this.platforms
            .create(2300, 450, "brick")
            .setScale(6, 1)
            .refreshBody();
          this.platforms
            .create(2600, 350, "brick")
            .setScale(4, 1)
            .refreshBody();

          // 大量の敵配置（夜なので強敵多め）
          this.createEnemy(300, 500, "koopa");
          this.createEnemy(400, 500, "koopa");
          this.createEnemy(500, 500, "goomba");
          this.createEnemy(700, 350, "koopa");
          this.createEnemy(800, 500, "koopa");
          this.createEnemy(900, 500, "goomba");
          this.createEnemy(1000, 300, "koopa");
          this.createEnemy(1100, 500, "koopa");
          this.createEnemy(1200, 500, "goomba");
          this.createEnemy(1300, 500, "koopa");
          this.createEnemy(1400, 200, "goomba");
          this.createEnemy(1500, 500, "koopa");
          this.createEnemy(1600, 500, "koopa");
          this.createEnemy(1700, 350, "goomba");
          this.createEnemy(1800, 500, "koopa");
          this.createEnemy(1900, 500, "koopa");
          this.createEnemy(2000, 250, "goomba");
          this.createEnemy(2100, 500, "koopa");
          this.createEnemy(2200, 500, "koopa");
          this.createEnemy(2300, 400, "goomba");
          this.createEnemy(2400, 500, "koopa");
          this.createEnemy(2500, 500, "koopa");
          this.createEnemy(2600, 300, "goomba");
          this.createEnemy(2700, 500, "koopa");
          this.createEnemy(2800, 500, "koopa");

          // スピニー（トゲゾー）も追加
          this.createEnemy(1150, 500, "spiny");
          this.createEnemy(1550, 500, "spiny");
          this.createEnemy(1950, 500, "spiny");
          this.createEnemy(2350, 500, "spiny");

          // 大量のコイン配置（地面の上）
          for (let x = 200; x < 2900; x += 40) {
            if (Math.random() > 0.2) {
              this.coins.create(x, 520, "coin").setScale(2);
            }
          }

          // プラットフォーム上のコイン
          for (let i = 0; i < 6; i++) {
            this.coins.create(980 + i * 40, 300, "coin").setScale(2);
          }
          for (let i = 0; i < 4; i++) {
            this.coins.create(1380 + i * 40, 200, "coin").setScale(2);
          }
          for (let i = 0; i < 5; i++) {
            this.coins.create(1680 + i * 40, 350, "coin").setScale(2);
          }
          for (let i = 0; i < 4; i++) {
            this.coins.create(1980 + i * 40, 250, "coin").setScale(2);
          }
          for (let i = 0; i < 6; i++) {
            this.coins.create(2280 + i * 40, 400, "coin").setScale(2);
          }

          // ジャンプで取れる高さのコイン（アーチ状）
          for (let x = 400; x < 2600; x += 200) {
            this.coins.create(x, 450, "coin").setScale(2);
            this.coins.create(x + 40, 420, "coin").setScale(2);
            this.coins.create(x + 80, 400, "coin").setScale(2);
            this.coins.create(x + 120, 420, "coin").setScale(2);
            this.coins.create(x + 160, 450, "coin").setScale(2);
          }

          // キノコ（地面の上に大量配置）
          this.powerups.create(400, 520, "mushroom").setScale(2);
          this.powerups.create(700, 520, "mushroom").setScale(2);
          this.powerups.create(1000, 520, "mushroom").setScale(2);
          this.powerups.create(1300, 520, "mushroom").setScale(2);
          this.powerups.create(1600, 520, "mushroom").setScale(2);
          this.powerups.create(1900, 520, "mushroom").setScale(2);
          this.powerups.create(2200, 520, "mushroom").setScale(2);
          this.powerups.create(2500, 520, "mushroom").setScale(2);
          this.powerups.create(2800, 520, "mushroom").setScale(2);

          // ファイアフラワーとスター
          this.powerups.create(1000, 300, "fireflower").setScale(2);
          this.powerups.create(1700, 350, "fireflower").setScale(2);
          this.powerups.create(2300, 400, "fireflower").setScale(2);
          this.powerups.create(1500, 300, "star").setScale(2);
          this.powerups.create(2600, 300, "star").setScale(2);
        }

        generateStage3() {
          // ピンクの空のステージ
          // 雲がたくさん（改善された配置）
          for (let x = 100; x < 3000; x += 150) {
            const cloudY = 50 + Math.random() * 120;
            const cloud = this.add.image(
              x + Math.random() * 50,
              cloudY,
              "cloud"
            );
            cloud.setScale(1 + Math.random() * 0.8);
            cloud.setAlpha(0.6 + Math.random() * 0.4);

            // 前景と背景の雲で奥行き感を演出
            if (Math.random() > 0.7) {
              const bgCloud = this.add.image(x + 75, cloudY + 30, "cloud");
              bgCloud.setScale(0.8 + Math.random() * 0.4);
              bgCloud.setAlpha(0.3 + Math.random() * 0.2);
              bgCloud.setDepth(-1);
            }
          }

          // ジャンプ台となるブロック
          for (let i = 0; i < 8; i++) {
            const y = 500 - i * 50;
            this.platforms
              .create(400 + i * 100, y, "brick")
              .setScale(2, 1)
              .refreshBody();
          }

          // 追加のプラットフォーム
          this.platforms
            .create(1600, 300, "brick")
            .setScale(4, 1)
            .refreshBody();
          this.platforms
            .create(1900, 400, "brick")
            .setScale(5, 1)
            .refreshBody();
          this.platforms
            .create(2000, 200, "brick")
            .setScale(4, 1)
            .refreshBody();
          this.platforms
            .create(2300, 350, "brick")
            .setScale(6, 1)
            .refreshBody();
          this.platforms
            .create(2600, 250, "brick")
            .setScale(4, 1)
            .refreshBody();

          // 大量の敵配置（空中の敵多め）
          this.createEnemy(350, 500, "goomba");
          this.createEnemy(450, 500, "koopa");
          this.createEnemy(550, 500, "goomba");
          this.createEnemy(650, 500, "koopa");
          this.createEnemy(750, 500, "goomba");
          this.createEnemy(850, 500, "koopa");
          this.createEnemy(950, 500, "goomba");
          this.createEnemy(1050, 500, "koopa");
          this.createEnemy(1150, 500, "goomba");
          this.createEnemy(1250, 500, "koopa");
          this.createEnemy(1350, 500, "goomba");
          this.createEnemy(1450, 500, "koopa");
          this.createEnemy(1550, 500, "goomba");
          this.createEnemy(1650, 500, "koopa");
          this.createEnemy(1750, 500, "goomba");
          this.createEnemy(1850, 500, "koopa");
          this.createEnemy(1950, 500, "goomba");
          this.createEnemy(2050, 500, "koopa");
          this.createEnemy(2150, 500, "goomba");
          this.createEnemy(2250, 500, "koopa");
          this.createEnemy(2350, 500, "goomba");
          this.createEnemy(2450, 500, "koopa");
          this.createEnemy(2550, 500, "goomba");
          this.createEnemy(2650, 500, "koopa");
          this.createEnemy(2750, 500, "goomba");

          // 空中の敵（ジュゲム）大量配置
          this.createEnemy(500, 150, "lakitu");
          this.createEnemy(700, 100, "lakitu");
          this.createEnemy(900, 150, "lakitu");
          this.createEnemy(1100, 100, "lakitu");
          this.createEnemy(1300, 150, "lakitu");
          this.createEnemy(1500, 100, "lakitu");
          this.createEnemy(1700, 150, "lakitu");
          this.createEnemy(1900, 100, "lakitu");
          this.createEnemy(2100, 150, "lakitu");
          this.createEnemy(2300, 100, "lakitu");
          this.createEnemy(2500, 150, "lakitu");
          this.createEnemy(2700, 100, "lakitu");

          // プラットフォーム上の敵
          this.createEnemy(1600, 250, "goomba");
          this.createEnemy(1900, 350, "koopa");
          this.createEnemy(2000, 150, "goomba");
          this.createEnemy(2300, 300, "koopa");
          this.createEnemy(2600, 200, "goomba");

          // 大量のコイン配置（地面の上）
          for (let x = 200; x < 2900; x += 35) {
            this.coins.create(x, 520, "coin").setScale(2);
          }

          // 階段状のコイン
          for (let i = 0; i < 8; i++) {
            const y = 450 - i * 50;
            for (let j = 0; j < 3; j++) {
              this.coins.create(380 + i * 100 + j * 20, y, "coin").setScale(2);
            }
          }

          // プラットフォーム上のコイン
          for (let i = 0; i < 4; i++) {
            this.coins.create(1580 + i * 40, 250, "coin").setScale(2);
          }
          for (let i = 0; i < 5; i++) {
            this.coins.create(1880 + i * 40, 350, "coin").setScale(2);
          }
          for (let i = 0; i < 4; i++) {
            this.coins.create(1980 + i * 40, 150, "coin").setScale(2);
          }
          for (let i = 0; i < 6; i++) {
            this.coins.create(2280 + i * 40, 300, "coin").setScale(2);
          }
          for (let i = 0; i < 4; i++) {
            this.coins.create(2580 + i * 40, 200, "coin").setScale(2);
          }

          // ジャンプで取れる高さのコイン（波状）
          for (let x = 300; x < 2700; x += 80) {
            const y = 400 + Math.sin(x / 100) * 50;
            this.coins.create(x, y, "coin").setScale(2);
            this.coins.create(x + 40, y - 30, "coin").setScale(2);
          }

          // キノコ（地面の上に大量配置）
          for (let x = 300; x < 2800; x += 200) {
            this.powerups.create(x, 520, "mushroom").setScale(2);
          }

          // プラットフォーム上のキノコ
          this.powerups.create(700, 350, "mushroom").setScale(2);
          this.powerups.create(1000, 200, "mushroom").setScale(2);
          this.powerups.create(1600, 250, "mushroom").setScale(2);
          this.powerups.create(2000, 150, "mushroom").setScale(2);
          this.powerups.create(2300, 300, "mushroom").setScale(2);

          // スターとファイアフラワー
          this.powerups.create(800, 250, "star").setScale(2);
          this.powerups.create(1200, 150, "star").setScale(2);
          this.powerups.create(1800, 100, "star").setScale(2);
          this.powerups.create(2400, 200, "star").setScale(2);
          this.powerups.create(1400, 300, "fireflower").setScale(2);
          this.powerups.create(2100, 250, "fireflower").setScale(2);
        }

        generateStage4() {
          // 地下ステージ
          // 天井
          for (let x = 0; x < 3200; x += 32) {
            this.platforms.create(x, 32, "brick").setScale(2, 2).refreshBody();
          }

          // 複雑な地形
          this.platforms.create(600, 400, "brick").setScale(8, 1).refreshBody();
          this.platforms.create(900, 300, "brick").setScale(4, 1).refreshBody();
          this.platforms
            .create(1200, 450, "brick")
            .setScale(6, 1)
            .refreshBody();
          this.platforms
            .create(1600, 350, "brick")
            .setScale(5, 1)
            .refreshBody();
          this.platforms
            .create(1900, 250, "brick")
            .setScale(4, 1)
            .refreshBody();
          this.platforms
            .create(2200, 400, "brick")
            .setScale(6, 1)
            .refreshBody();
          this.platforms
            .create(2500, 300, "brick")
            .setScale(5, 1)
            .refreshBody();

          // 土管（複数配置）
          this.platforms.create(800, 504, "pipe").setScale(2).refreshBody();
          this.platforms.create(1200, 386, "pipe").setScale(2).refreshBody();
          this.platforms.create(1600, 286, "pipe").setScale(2).refreshBody();
          this.platforms.create(2000, 504, "pipe").setScale(2).refreshBody();
          this.platforms.create(2400, 504, "pipe").setScale(2).refreshBody();

          // パックンフラワー（全ての土管から）
          const pipes = [
            { x: 800, y: 504, piranhaY: 410 },
            { x: 1200, y: 386, piranhaY: 290 },
            { x: 1600, y: 286, piranhaY: 190 },
            { x: 2000, y: 504, piranhaY: 410 },
            { x: 2400, y: 504, piranhaY: 410 },
          ];

          pipes.forEach((pipe) => {
            const piranha = this.enemies.create(
              pipe.x,
              pipe.piranhaY,
              "piranha"
            );
            piranha.setScale(2);
            piranha.body.setAllowGravity(false);

            this.tweens.add({
              targets: piranha,
              y: pipe.piranhaY + 40,
              duration: 2000,
              yoyo: true,
              repeat: -1,
              ease: "Sine.easeInOut",
            });
          });

          // 大量の敵配置
          this.createEnemy(300, 500, "goomba");
          this.createEnemy(400, 500, "koopa");
          this.createEnemy(500, 500, "goomba");
          this.createEnemy(600, 350, "goomba");
          this.createEnemy(700, 500, "koopa");
          this.createEnemy(900, 250, "goomba");
          this.createEnemy(1000, 500, "koopa");
          this.createEnemy(1100, 500, "goomba");
          this.createEnemy(1300, 500, "koopa");
          this.createEnemy(1400, 500, "goomba");
          this.createEnemy(1500, 500, "koopa");
          this.createEnemy(1600, 300, "goomba");
          this.createEnemy(1700, 500, "koopa");
          this.createEnemy(1800, 500, "goomba");
          this.createEnemy(1900, 200, "goomba");
          this.createEnemy(2100, 500, "koopa");
          this.createEnemy(2200, 350, "goomba");
          this.createEnemy(2300, 500, "koopa");
          this.createEnemy(2500, 250, "goomba");
          this.createEnemy(2600, 500, "koopa");
          this.createEnemy(2700, 500, "goomba");
          this.createEnemy(2800, 500, "koopa");

          // ハンマーブロスとスピニー（強敵）
          this.createEnemy(750, 350, "hammerbro");
          this.createEnemy(1150, 400, "hammerbro");
          this.createEnemy(1550, 300, "hammerbro");
          this.createEnemy(1950, 350, "hammerbro");
          this.createEnemy(2350, 350, "hammerbro");
          this.createEnemy(2650, 250, "hammerbro");

          this.createEnemy(650, 500, "spiny");
          this.createEnemy(1050, 500, "spiny");
          this.createEnemy(1450, 500, "spiny");
          this.createEnemy(1850, 500, "spiny");
          this.createEnemy(2250, 500, "spiny");
          this.createEnemy(2550, 500, "spiny");

          // 大量のコイン配置（地面の上）
          for (let x = 200; x < 2900; x += 30) {
            this.coins.create(x, 520, "coin").setScale(2);
          }

          // プラットフォーム上のコイン
          for (let i = 0; i < 8; i++) {
            this.coins.create(580 + i * 40, 350, "coin").setScale(2);
          }
          for (let i = 0; i < 4; i++) {
            this.coins.create(880 + i * 40, 250, "coin").setScale(2);
          }
          for (let i = 0; i < 6; i++) {
            this.coins.create(1180 + i * 40, 400, "coin").setScale(2);
          }
          for (let i = 0; i < 5; i++) {
            this.coins.create(1580 + i * 40, 300, "coin").setScale(2);
          }
          for (let i = 0; i < 4; i++) {
            this.coins.create(1880 + i * 40, 200, "coin").setScale(2);
          }
          for (let i = 0; i < 6; i++) {
            this.coins.create(2180 + i * 40, 350, "coin").setScale(2);
          }
          for (let i = 0; i < 5; i++) {
            this.coins.create(2480 + i * 40, 250, "coin").setScale(2);
          }

          // ジャンプで取れる高さのコイン（ジグザグ配置）
          for (let x = 300; x < 2700; x += 100) {
            const y = x % 200 === 0 ? 450 : 400;
            this.coins.create(x, y, "coin").setScale(2);
            this.coins.create(x + 50, y - 50, "coin").setScale(2);
          }

          // キノコ（地面の上に大量配置）
          for (let x = 250; x < 2850; x += 150) {
            this.powerups.create(x, 520, "mushroom").setScale(2);
          }

          // プラットフォーム上のキノコ
          this.powerups.create(650, 350, "mushroom").setScale(2);
          this.powerups.create(950, 250, "mushroom").setScale(2);
          this.powerups.create(1250, 400, "mushroom").setScale(2);
          this.powerups.create(1650, 300, "mushroom").setScale(2);
          this.powerups.create(1950, 200, "mushroom").setScale(2);
          this.powerups.create(2250, 350, "mushroom").setScale(2);
          this.powerups.create(2550, 250, "mushroom").setScale(2);

          // ファイアフラワーとスター
          this.powerups.create(800, 350, "fireflower").setScale(2);
          this.powerups.create(1400, 350, "fireflower").setScale(2);
          this.powerups.create(2000, 350, "fireflower").setScale(2);
          this.powerups.create(2600, 200, "fireflower").setScale(2);
          this.powerups.create(1000, 250, "star").setScale(2);
          this.powerups.create(1700, 250, "star").setScale(2);
          this.powerups.create(2300, 300, "star").setScale(2);
        }

        generateStage5() {
          // 最終ステージ - 城
          // 城の背景
          this.add.image(2800, 400, "castle").setScale(2);

          // 溶岩（視覚効果のみ）
          for (let x = 600; x < 2400; x += 100) {
            const lava = this.add.rectangle(x, 580, 100, 40, 0xff4500);
            this.tweens.add({
              targets: lava,
              y: 560,
              duration: 1000,
              yoyo: true,
              repeat: -1,
              ease: "Sine.easeInOut",
            });
          }

          // 小さな足場（より多く、より狭く）
          for (let i = 0; i < 15; i++) {
            const x = 600 + i * 120;
            const y = 450 - (i % 4) * 60;
            this.platforms.create(x, y, "brick").setScale(1.5, 1).refreshBody();
          }

          // 追加のプラットフォーム
          this.platforms
            .create(2200, 350, "brick")
            .setScale(6, 1)
            .refreshBody();
          this.platforms
            .create(2500, 250, "brick")
            .setScale(4, 1)
            .refreshBody();
          this.platforms
            .create(2700, 400, "brick")
            .setScale(5, 1)
            .refreshBody();

          // 大量の強敵配置
          // ハンマーブロス軍団
          this.createEnemy(700, 400, "hammerbro");
          this.createEnemy(900, 350, "hammerbro");
          this.createEnemy(1100, 400, "hammerbro");
          this.createEnemy(1300, 300, "hammerbro");
          this.createEnemy(1500, 400, "hammerbro");
          this.createEnemy(1700, 350, "hammerbro");
          this.createEnemy(1900, 400, "hammerbro");
          this.createEnemy(2100, 300, "hammerbro");
          this.createEnemy(2300, 300, "hammerbro");
          this.createEnemy(2500, 200, "hammerbro");
          this.createEnemy(2700, 350, "hammerbro");

          // スピニー軍団
          this.createEnemy(600, 500, "spiny");
          this.createEnemy(750, 500, "spiny");
          this.createEnemy(850, 500, "spiny");
          this.createEnemy(1000, 500, "spiny");
          this.createEnemy(1150, 500, "spiny");
          this.createEnemy(1250, 500, "spiny");
          this.createEnemy(1400, 500, "spiny");
          this.createEnemy(1550, 500, "spiny");
          this.createEnemy(1650, 500, "spiny");
          this.createEnemy(1800, 500, "spiny");
          this.createEnemy(1950, 500, "spiny");
          this.createEnemy(2050, 500, "spiny");
          this.createEnemy(2150, 500, "spiny");
          this.createEnemy(2250, 500, "spiny");
          this.createEnemy(2350, 500, "spiny");
          this.createEnemy(2450, 500, "spiny");
          this.createEnemy(2550, 500, "spiny");
          this.createEnemy(2650, 500, "spiny");
          this.createEnemy(2750, 500, "spiny");
          this.createEnemy(2850, 500, "spiny");

          // 空中の敵（ジュゲム）
          this.createEnemy(800, 150, "lakitu");
          this.createEnemy(1000, 100, "lakitu");
          this.createEnemy(1200, 150, "lakitu");
          this.createEnemy(1400, 100, "lakitu");
          this.createEnemy(1600, 150, "lakitu");
          this.createEnemy(1800, 100, "lakitu");
          this.createEnemy(2000, 150, "lakitu");
          this.createEnemy(2200, 100, "lakitu");
          this.createEnemy(2400, 150, "lakitu");
          this.createEnemy(2600, 100, "lakitu");

          // ノコノコ軍団
          this.createEnemy(650, 500, "koopa");
          this.createEnemy(800, 500, "koopa");
          this.createEnemy(950, 500, "koopa");
          this.createEnemy(1100, 500, "koopa");
          this.createEnemy(1300, 500, "koopa");
          this.createEnemy(1450, 500, "koopa");
          this.createEnemy(1600, 500, "koopa");
          this.createEnemy(1750, 500, "koopa");
          this.createEnemy(1900, 500, "koopa");
          this.createEnemy(2100, 500, "koopa");
          this.createEnemy(2300, 300, "koopa");
          this.createEnemy(2500, 200, "koopa");
          this.createEnemy(2700, 350, "koopa");

          // 大量のコイン配置（地面の上）
          for (let x = 200; x < 2900; x += 25) {
            this.coins.create(x, 520, "coin").setScale(2);
          }

          // プラットフォーム上のコイン（小さな足場にも）
          for (let i = 0; i < 15; i++) {
            const x = 600 + i * 120;
            const y = 450 - (i % 4) * 60;
            this.coins.create(x - 10, y - 50, "coin").setScale(2);
            this.coins.create(x, y - 50, "coin").setScale(2);
            this.coins.create(x + 10, y - 50, "coin").setScale(2);
          }

          // 大量のコイン（プラットフォーム上）
          for (let i = 0; i < 8; i++) {
            this.coins.create(2180 + i * 40, 300, "coin").setScale(2);
          }
          for (let i = 0; i < 6; i++) {
            this.coins.create(2480 + i * 40, 200, "coin").setScale(2);
          }
          for (let i = 0; i < 7; i++) {
            this.coins.create(2680 + i * 40, 350, "coin").setScale(2);
          }

          // ジャンプで取れる高さのコイン（大量）
          for (let x = 300; x < 2800; x += 60) {
            this.coins.create(x, 450, "coin").setScale(2);
            this.coins.create(x + 30, 420, "coin").setScale(2);
            this.coins.create(x, 390, "coin").setScale(2);
            this.coins.create(x + 30, 360, "coin").setScale(2);
          }

          // キノコ（地面の上に大量配置）
          for (let x = 300; x < 2800; x += 100) {
            this.powerups.create(x, 520, "mushroom").setScale(2);
          }

          // パワーアップ（超大量）
          this.powerups.create(700, 350, "fireflower").setScale(2);
          this.powerups.create(900, 300, "star").setScale(2);
          this.powerups.create(1100, 350, "fireflower").setScale(2);
          this.powerups.create(1300, 250, "star").setScale(2);
          this.powerups.create(1500, 350, "fireflower").setScale(2);
          this.powerups.create(1700, 300, "star").setScale(2);
          this.powerups.create(1900, 350, "fireflower").setScale(2);
          this.powerups.create(2100, 250, "star").setScale(2);
          this.powerups.create(2200, 300, "mushroom").setScale(2);
          this.powerups.create(2300, 300, "fireflower").setScale(2);
          this.powerups.create(2400, 250, "star").setScale(2);
          this.powerups.create(2500, 200, "mushroom").setScale(2);
          this.powerups.create(2600, 250, "fireflower").setScale(2);
          this.powerups.create(2700, 350, "star").setScale(2);

          // プラットフォーム上のキノコ
          for (let i = 0; i < 15; i++) {
            if (i % 3 === 0) {
              const x = 600 + i * 120;
              const y = 450 - (i % 4) * 60;
              this.powerups.create(x, y - 50, "mushroom").setScale(2);
            }
          }
        }

        createQuestionBlock(x, y, content) {
          const block = this.platforms.create(x, y, "question");
          block.setScale(2);
          block.refreshBody();
          block.content = content;
          block.hit = false;
        }

        createEnemy(x, y, type) {
          const enemy = this.enemies.create(x, y, type);
          enemy.setScale(2);
          enemy.setBounce(1, 0);
          enemy.setVelocityX(Phaser.Math.Between(-50, -100));
          enemy.enemyType = type;

          // 敵の動作パターン
          if (type === "lakitu") {
            enemy.body.setAllowGravity(false);
            this.tweens.add({
              targets: enemy,
              x: x + 200,
              duration: 3000,
              yoyo: true,
              repeat: -1,
              ease: "Sine.easeInOut",
            });
          }
        }

        createUI() {
          const uiStyle = {
            fontSize: "20px",
            fontFamily: "Arial",
            color: "#FFFFFF",
            stroke: "#000000",
            strokeThickness: 4,
          };

          this.scoreText = this.add.text(
            16,
            16,
            "SCORE: " + this.score,
            uiStyle
          );
          this.livesText = this.add.text(
            16,
            50,
            "LIVES: " + this.lives,
            uiStyle
          );
          this.stageText = this.add.text(
            16,
            84,
            "STAGE: " + this.currentStage,
            uiStyle
          );

          this.scoreText.setScrollFactor(0);
          this.livesText.setScrollFactor(0);
          this.stageText.setScrollFactor(0);
        }

        setupMobileControls() {
          const leftBtn = document.getElementById("leftBtn");
          const rightBtn = document.getElementById("rightBtn");
          const jumpBtn = document.getElementById("jumpBtn");

          this.mobileControls = {
            left: false,
            right: false,
            jump: false,
          };

          if (leftBtn) {
            leftBtn.addEventListener("touchstart", (e) => {
              e.preventDefault();
              this.mobileControls.left = true;
            });
            leftBtn.addEventListener("touchend", (e) => {
              e.preventDefault();
              this.mobileControls.left = false;
            });
          }

          if (rightBtn) {
            rightBtn.addEventListener("touchstart", (e) => {
              e.preventDefault();
              this.mobileControls.right = true;
            });
            rightBtn.addEventListener("touchend", (e) => {
              e.preventDefault();
              this.mobileControls.right = false;
            });
          }

          if (jumpBtn) {
            jumpBtn.addEventListener("touchstart", (e) => {
              e.preventDefault();
              this.mobileControls.jump = true;
            });
            jumpBtn.addEventListener("touchend", (e) => {
              e.preventDefault();
              this.mobileControls.jump = false;
            });
          }
        }

        update() {
          if (!this.player.active) return;

          const isJumping = !this.player.body.touching.down;

          if (this.cursors.left.isDown || this.mobileControls.left) {
            this.player.setVelocityX(-200);
            this.player.setFlipX(true);
            if (!isJumping) {
              this.player.play("walk", true);
            }
          } else if (this.cursors.right.isDown || this.mobileControls.right) {
            this.player.setVelocityX(200);
            this.player.setFlipX(false);
            if (!isJumping) {
              this.player.play("walk", true);
            }
          } else {
            this.player.setVelocityX(0);
            if (!isJumping) {
              this.player.play("idle", true);
            }
          }

          if (
            (this.spaceKey.isDown || this.mobileControls.jump) &&
            this.player.body.touching.down
          ) {
            this.player.setVelocityY(-480);
          }

          if (isJumping) {
            this.player.play("jump", true);
          }

          if (this.player.y > 650) {
            this.playerDeath(true);
          }

          // 左右の壁制限
          if (this.player.x < 0) {
            this.player.x = 0;
            this.player.setVelocityX(0);
          } else if (this.player.x > 3200) {
            this.player.x = 3200;
            this.player.setVelocityX(0);
          }

          this.enemies.children.entries.forEach((enemy) => {
            if (enemy.x < 0 || enemy.x > 3200) {
              enemy.setVelocityX(-enemy.body.velocity.x);
            }
          });
        }

        collectCoin(player, coin) {
          coin.destroy();
          this.score += 100;
          this.scoreText.setText("SCORE: " + this.score);

          // コイン取得エフェクト
          const coinEffect = this.add.text(coin.x, coin.y, "+100", {
            fontSize: "16px",
            color: "#FFD700",
          });

          this.tweens.add({
            targets: coinEffect,
            y: coin.y - 50,
            alpha: 0,
            duration: 1000,
            onComplete: () => coinEffect.destroy(),
          });
        }

        collectPowerup(player, powerup) {
          const powerupType = powerup.texture.key;
          powerup.destroy();

          switch (powerupType) {
            case "mushroom":
              this.score += 1000;
              player.isSuper = true;
              player.setScale(4);
              player.body.setSize(14, 16);
              player.body.setOffset(1, 0);
              this.time.delayedCall(10000, () => {
                if (player.active && player.isSuper) {
                  player.isSuper = false;
                  player.setScale(3);
                  player.body.setSize(14, 16);
                  player.body.setOffset(1, 0);
                }
              });
              break;

            case "fireflower":
              this.score += 1500;
              player.setTint(0xff6666);
              this.time.delayedCall(10000, () => {
                if (player.active) player.clearTint();
              });
              break;

            case "star":
              this.score += 2000;
              player.setTint(0xffd700);
              this.time.delayedCall(5000, () => {
                if (player.active) player.clearTint();
              });
              break;

            default:
              this.score += 1000;
              break;
          }

          this.scoreText.setText("SCORE: " + this.score);

          const effect = this.add.text(
            powerup.x,
            powerup.y,
            "+" +
              (powerupType === "star"
                ? "2000"
                : powerupType === "fireflower"
                ? "1500"
                : "1000"),
            {
              fontSize: "20px",
              color: "#FFD700",
              stroke: "#000000",
              strokeThickness: 3,
            }
          );

          this.tweens.add({
            targets: effect,
            y: powerup.y - 50,
            alpha: 0,
            duration: 1000,
            onComplete: () => effect.destroy(),
          });
        }

        hitEnemy(player, enemy) {
          if (player.body.velocity.y > 0 && player.y < enemy.y) {
            enemy.destroy();
            this.score += 200;
            this.scoreText.setText("SCORE: " + this.score);
            player.setVelocityY(-300);
          } else if (
            player.tintTopLeft === 0xffd700 ||
            player.tintTopLeft === 0xff6666
          ) {
            enemy.destroy();
            this.score += 200;
            this.scoreText.setText("SCORE: " + this.score);
          } else if (player.isSuper) {
            player.isSuper = false;
            player.setScale(3);
            player.body.setSize(14, 16);
            player.body.setOffset(1, 0);
            player.setTint(0xff0000);
            this.time.delayedCall(1000, () => {
              if (player.active) player.clearTint();
            });
          } else {
            this.playerDeath();
          }
        }

        playerDeath(fallenInHole = false) {
          this.player.active = false;
          this.player.anims.stop();
          this.player.setTint(0xff0000);
          this.player.setVelocityX(0);

          if (fallenInHole) {
            // 穴に落ちた場合：そのまま下に消えていく
            this.player.setVelocityY(400);
          } else {
            // 敵にやられた場合：跳ね上がる演出
            this.player.setVelocityY(-480);
          }

          this.time.delayedCall(1000, () => {
            this.lives--;

            if (this.lives > 0) {
              this.scene.restart({
                stage: this.currentStage,
                score: this.score,
                lives: this.lives,
              });
            } else {
              this.scene.start("GameOverScene", { score: this.score });
            }
          });
        }

        reachFlag(player, flag) {
          player.active = false;
          player.anims.stop();
          player.setVelocityX(0);

          this.tweens.add({
            targets: flag,
            y: 480,
            duration: 1000,
            onComplete: () => {
              if (this.currentStage < 5) {
                this.scene.start("GameScene", {
                  stage: this.currentStage + 1,
                  score: this.score + 5000,
                  lives: this.lives,
                });
              } else {
                this.scene.start("VictoryScene", { score: this.score + 10000 });
              }
            },
          });
        }
      }

      // ゲームオーバーシーン
      class GameOverScene extends Phaser.Scene {
        constructor() {
          super({ key: "GameOverScene" });
        }

        init(data) {
          this.finalScore = data.score || 0;
        }

        create() {
          this.cameras.main.setBackgroundColor("#000000");

          const textStyle = {
            fontSize: "48px",
            fontFamily: "Arial Black",
            color: "#FFFFFF",
            stroke: "#FF0000",
            strokeThickness: 6,
          };

          this.add.text(400, 200, "GAME OVER", textStyle).setOrigin(0.5);

          this.add
            .text(400, 300, "FINAL SCORE: " + this.finalScore, {
              fontSize: "32px",
              fontFamily: "Arial",
              color: "#FFD700",
            })
            .setOrigin(0.5);

          const restartText = this.add
            .text(400, 400, "PRESS SPACE or TAP TO RESTART", {
              fontSize: "24px",
              fontFamily: "Arial",
              color: "#FFFFFF",
            })
            .setOrigin(0.5);

          this.tweens.add({
            targets: restartText,
            alpha: 0,
            duration: 500,
            yoyo: true,
            repeat: -1,
          });

          this.input.keyboard.once("keydown-SPACE", () => {
            this.scene.start("TitleScene");
          });

          this.input.once("pointerdown", () => {
            this.scene.start("TitleScene");
          });
        }
      }

      // 勝利シーン
      class VictoryScene extends Phaser.Scene {
        constructor() {
          super({ key: "VictoryScene" });
        }

        init(data) {
          this.finalScore = data.score || 0;
        }

        create() {
          this.cameras.main.setBackgroundColor("#FFD700");

          // 花火エフェクト
          for (let i = 0; i < 10; i++) {
            this.time.delayedCall(i * 500, () => {
              const x = Phaser.Math.Between(100, 700);
              const y = Phaser.Math.Between(100, 300);
              this.createFirework(x, y);
            });
          }

          const textStyle = {
            fontSize: "48px",
            fontFamily: "Arial Black",
            color: "#FFFFFF",
            stroke: "#000000",
            strokeThickness: 8,
          };

          this.add.text(400, 200, "CONGRATULATIONS!", textStyle).setOrigin(0.5);
          this.add.text(400, 280, "YOU WIN!", textStyle).setOrigin(0.5);

          this.add
            .text(400, 360, "FINAL SCORE: " + this.finalScore, {
              fontSize: "32px",
              fontFamily: "Arial",
              color: "#FF0000",
              stroke: "#000000",
              strokeThickness: 4,
            })
            .setOrigin(0.5);

          const restartText = this.add
            .text(400, 450, "PRESS SPACE or TAP TO PLAY AGAIN", {
              fontSize: "24px",
              fontFamily: "Arial",
              color: "#000000",
            })
            .setOrigin(0.5);

          this.tweens.add({
            targets: restartText,
            alpha: 0,
            duration: 500,
            yoyo: true,
            repeat: -1,
          });

          this.input.keyboard.once("keydown-SPACE", () => {
            this.scene.start("TitleScene");
          });

          this.input.once("pointerdown", () => {
            this.scene.start("TitleScene");
          });
        }

        createFirework(x, y) {
          const colors = [
            0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff, 0x00ffff,
          ];
          const color = Phaser.Utils.Array.GetRandom(colors);

          for (let i = 0; i < 12; i++) {
            const angle = (i / 12) * Math.PI * 2;
            const particle = this.add.rectangle(x, y, 4, 4, color);

            this.tweens.add({
              targets: particle,
              x: x + Math.cos(angle) * 100,
              y: y + Math.sin(angle) * 100,
              alpha: 0,
              duration: 1000,
              ease: "Power2",
              onComplete: () => particle.destroy(),
            });
          }
        }
      }

      // ゲーム設定
      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: "game-container",
        physics: {
          default: "arcade",
          arcade: {
            gravity: { y: 800 },
            debug: false,
          },
        },
        scene: [TitleScene, GameScene, GameOverScene, VictoryScene],
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH,
          max: {
            width: 800,
            height: 600,
          },
        },
        pixelArt: true,
      };

      // ゲーム開始
      const game = new Phaser.Game(config);
    </script>
  </body>
</html>
